name: Deploy Portfolio

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CLOUDFRONT_DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Deploy to S3
        run: |
          set -euo pipefail

          # 静的アセット（長期キャッシュ: 1年）
          aws s3 sync out/ s3://${{ secrets.AWS_S3_BUCKET }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "*.json"

          # HTML/JSON ファイル（キャッシュなし: 常に最新を取得）
          aws s3 sync out/ s3://${{ secrets.AWS_S3_BUCKET }} \
            --cache-control "public, max-age=0, must-revalidate" \
            --exclude "*" \
            --include "*.html" \
            --include "*.json"

      - name: Get changed files for invalidation
        id: changed-files
        run: |
          # 変更されたファイルを取得（_next/static/ は除外）
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'src/' 'public/' 2>/dev/null || echo "")
          
          # 初回デプロイまたはgit履歴がない場合は全削除
          if [ -z "$CHANGED_FILES" ]; then
            echo "paths=/*" >> $GITHUB_OUTPUT
            echo "strategy=full" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # outディレクトリ内の対応するパスに変換
          INVALIDATION_PATHS=""
          PATH_COUNT=0
          
          for file in $CHANGED_FILES; do
            # src/app/ 配下のファイルを対応するHTMLパスに変換
            if [[ "$file" == src/app/*/page.tsx ]] || [[ "$file" == src/app/page.tsx ]]; then
              # page.tsx -> 対応するHTMLパス
              path=$(echo "$file" | sed 's|src/app||' | sed 's|/page\.tsx||' | sed 's|^$|/|')
              # 動的ルートセグメント [param] を含む場合はワイルドカードに変換
              if [[ "$path" == *"["* ]]; then
                path=$(echo "$path" | sed 's|/\[[^]]*\].*|/*|')
                INVALIDATION_PATHS="$INVALIDATION_PATHS ${path}"
                PATH_COUNT=$((PATH_COUNT + 1))
              elif [ "$path" = "/" ]; then
                INVALIDATION_PATHS="$INVALIDATION_PATHS /index.html"
                PATH_COUNT=$((PATH_COUNT + 1))
              else
                INVALIDATION_PATHS="$INVALIDATION_PATHS ${path}.html ${path}/index.html"
                PATH_COUNT=$((PATH_COUNT + 2))
              fi
            elif [[ "$file" == src/app/* ]]; then
              # layout.tsx, error.tsx, loading.tsx, not-found.tsx などの非ページファイル
              # これらの変更は複数ページに影響するため、ディレクトリ単位で無効化
              dir=$(echo "$file" | sed 's|src/app/\?||' | sed 's|/[^/]*$||')
              if [ "$dir" = "$(basename "$file")" ] || [ -z "$dir" ]; then
                # ルートレベルの非ページファイル → 全体無効化にフォールバック
                echo "paths=/*" >> $GITHUB_OUTPUT
                echo "strategy=full" >> $GITHUB_OUTPUT
                exit 0
              else
                # 動的ルートセグメント [param] を含む場合はその手前まで
                if [[ "$dir" == *"["* ]]; then
                  dir=$(echo "$dir" | sed 's|/\[[^]]*\].*||')
                fi
                INVALIDATION_PATHS="$INVALIDATION_PATHS /${dir}/*"
                PATH_COUNT=$((PATH_COUNT + 1))
              fi
            fi
            
            # publicディレクトリのファイル
            if [[ "$file" == public/* ]]; then
              path=$(echo "$file" | sed 's|public||')
              # _next/static/ は除外（ハッシュ付きのため不要）
              if [[ "$path" != /_next/static/* ]]; then
                INVALIDATION_PATHS="$INVALIDATION_PATHS $path"
                PATH_COUNT=$((PATH_COUNT + 1))
              fi
            fi
          done
          
          # パス数が50を超える場合は全削除にフォールバック
          if [ $PATH_COUNT -gt 50 ]; then
            echo "paths=/*" >> $GITHUB_OUTPUT
            echo "strategy=full" >> $GITHUB_OUTPUT
          elif [ -z "$INVALIDATION_PATHS" ]; then
            echo "paths=/*" >> $GITHUB_OUTPUT
            echo "strategy=full" >> $GITHUB_OUTPUT
          else
            # 重複を除去してスペース区切りで出力
            UNIQUE_PATHS=$(echo "$INVALIDATION_PATHS" | tr ' ' '\n' | sort -u | tr '\n' ' ')
            echo "paths=$UNIQUE_PATHS" >> $GITHUB_OUTPUT
            echo "strategy=selective" >> $GITHUB_OUTPUT
          fi

      - name: Invalidate CloudFront cache
        if: ${{ env.CLOUDFRONT_DIST_ID != '' }}
        run: |
          set -eu

          echo "Invalidation strategy: ${{ steps.changed-files.outputs.strategy }}"
          echo "Paths to invalidate: ${{ steps.changed-files.outputs.paths }}"
          
          aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_DIST_ID" \
            --paths ${{ steps.changed-files.outputs.paths }}