<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ポモドーロタイマー</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    h1 {
      color: #fff;
      font-size: 1.75rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 8px;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.875rem;
      text-align: center;
      margin-bottom: 28px;
    }

    /* モード切替タブ */
    .mode-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 32px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 4px;
    }

    .mode-tab {
      flex: 1;
      padding: 10px 8px;
      border: none;
      border-radius: 10px;
      background: transparent;
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mode-tab:hover {
      color: rgba(255, 255, 255, 0.8);
    }

    .mode-tab.active-work {
      background: rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .mode-tab.active-short {
      background: rgba(34, 197, 94, 0.3);
      color: #86efac;
    }

    .mode-tab.active-long {
      background: rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }

    /* 円形プログレス */
    .timer-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 32px;
    }

    .timer-circle {
      position: relative;
      width: 220px;
      height: 220px;
    }

    .timer-circle svg {
      transform: rotate(-90deg);
      width: 220px;
      height: 220px;
    }

    .progress-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.08);
      stroke-width: 8;
    }

    .progress-bar {
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease;
    }

    .timer-display {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .timer-time {
      color: #fff;
      font-size: 3rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      letter-spacing: 2px;
    }

    .timer-label {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-top: 4px;
    }

    /* コントロールボタン */
    .controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 28px;
    }

    .btn-control {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-control:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .btn-control:active {
      transform: scale(0.95);
    }

    .btn-primary {
      width: 72px;
      height: 72px;
      border: none;
    }

    .btn-primary.work-mode {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 8px 20px -8px rgba(239, 68, 68, 0.5);
    }

    .btn-primary.short-mode {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      box-shadow: 0 8px 20px -8px rgba(34, 197, 94, 0.5);
    }

    .btn-primary.long-mode {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      box-shadow: 0 8px 20px -8px rgba(59, 130, 246, 0.5);
    }

    .btn-primary:hover {
      transform: scale(1.08);
    }

    /* セッション情報 */
    .session-info {
      display: flex;
      justify-content: center;
      gap: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .session-stat {
      text-align: center;
    }

    .session-stat .stat-value {
      color: #fff;
      font-size: 1.25rem;
      font-weight: 700;
    }

    .session-stat .stat-label {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 2px;
    }

    /* セッションドットインジケータ */
    .session-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .session-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      transition: all 0.3s;
    }

    .session-dot.completed {
      background: #ef4444;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
    }

    .session-dot.current {
      background: rgba(255, 255, 255, 0.4);
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.85); }
    }

    /* 完了アニメーション */
    @keyframes celebrate {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    .celebrate .timer-display {
      animation: celebrate 0.5s ease-in-out 3;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

    /** タイマーのモード定義 */
    const MODES = {
      work:       { label: '作業',         minutes: 25, color: '#ef4444', className: 'work' },
      shortBreak: { label: '小休憩',       minutes: 5,  color: '#22c55e', className: 'short' },
      longBreak:  { label: '長休憩',       minutes: 15, color: '#3b82f6', className: 'long' },
    };

    /** 4セッションで1サイクル */
    const SESSIONS_PER_CYCLE = 4;

    /** SVG円周 */
    const RADIUS = 100;
    const CIRCUMFERENCE = 2 * Math.PI * RADIUS;

    /**
     * 時間を MM:SS 形式にフォーマット
     * @param {number} totalSeconds - 秒数
     * @returns {string}
     */
    function formatTime(totalSeconds) {
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    /** SVGアイコン: 再生 */
    function PlayIcon() {
      return (
        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
          <polygon points="6,3 20,12 6,21" />
        </svg>
      );
    }

    /** SVGアイコン: 一時停止 */
    function PauseIcon() {
      return (
        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
          <rect x="5" y="3" width="5" height="18" rx="1" />
          <rect x="14" y="3" width="5" height="18" rx="1" />
        </svg>
      );
    }

    /** SVGアイコン: リセット */
    function ResetIcon() {
      return (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="1 4 1 10 7 10" />
          <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
        </svg>
      );
    }

    /** SVGアイコン: スキップ */
    function SkipIcon() {
      return (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <polygon points="5,3 15,12 5,21" />
          <rect x="17" y="3" width="3" height="18" rx="1" />
        </svg>
      );
    }

    /**
     * セッション進捗のドットインジケータ
     */
    function SessionDots({ completedSessions, currentMode }) {
      return (
        <div className="session-dots">
          {Array.from({ length: SESSIONS_PER_CYCLE }, (_, i) => {
            let className = 'session-dot';
            if (i < completedSessions % SESSIONS_PER_CYCLE) {
              className += ' completed';
            } else if (i === completedSessions % SESSIONS_PER_CYCLE && currentMode === 'work') {
              className += ' current';
            }
            return <div key={i} className={className} />;
          })}
        </div>
      );
    }

    /**
     * 円形プログレスバー付きタイマー表示
     */
    function TimerCircle({ secondsLeft, totalSeconds, mode, isRunning }) {
      const progress = totalSeconds > 0 ? secondsLeft / totalSeconds : 1;
      const offset = CIRCUMFERENCE * (1 - progress);
      const modeConfig = MODES[mode];

      return (
        <div className={`timer-circle ${secondsLeft === 0 && !isRunning ? 'celebrate' : ''}`}>
          <svg viewBox="0 0 220 220">
            <circle className="progress-bg" cx="110" cy="110" r={RADIUS} />
            <circle
              className="progress-bar"
              cx="110"
              cy="110"
              r={RADIUS}
              stroke={modeConfig.color}
              strokeDasharray={CIRCUMFERENCE}
              strokeDashoffset={offset}
            />
          </svg>
          <div className="timer-display">
            <div className="timer-time">{formatTime(secondsLeft)}</div>
            <div className="timer-label">{modeConfig.label}</div>
          </div>
        </div>
      );
    }

    /**
     * メインのポモドーロタイマーアプリ
     */
    function PomodoroApp() {
      const [mode, setMode] = useState('work');
      const [secondsLeft, setSecondsLeft] = useState(MODES.work.minutes * 60);
      const [isRunning, setIsRunning] = useState(false);
      const [completedSessions, setCompletedSessions] = useState(0);
      const [totalWorkMinutes, setTotalWorkMinutes] = useState(0);

      const intervalRef = useRef(null);
      const audioRef = useRef(null);

      const totalSeconds = MODES[mode].minutes * 60;

      /** 通知音を鳴らす */
      const playNotification = useCallback(() => {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = ctx.createOscillator();
          const gain = ctx.createGain();
          oscillator.connect(gain);
          gain.connect(ctx.destination);

          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(587.33, ctx.currentTime);     // D5
          gain.gain.setValueAtTime(0.3, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
          oscillator.start(ctx.currentTime);
          oscillator.stop(ctx.currentTime + 0.8);

          // 2音目
          const osc2 = ctx.createOscillator();
          const gain2 = ctx.createGain();
          osc2.connect(gain2);
          gain2.connect(ctx.destination);
          osc2.type = 'sine';
          osc2.frequency.setValueAtTime(783.99, ctx.currentTime + 0.3);     // G5
          gain2.gain.setValueAtTime(0.3, ctx.currentTime + 0.3);
          gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1.1);
          osc2.start(ctx.currentTime + 0.3);
          osc2.stop(ctx.currentTime + 1.1);
        } catch {
          // AudioContext が利用できない環境ではスキップ
        }
      }, []);

      /** タイマー完了時の処理 */
      const handleTimerComplete = useCallback(() => {
        setIsRunning(false);
        playNotification();

        if (mode === 'work') {
          const newCompleted = completedSessions + 1;
          setCompletedSessions(newCompleted);
          setTotalWorkMinutes(prev => prev + MODES.work.minutes);

          // 4セッションごとに長休憩
          if (newCompleted % SESSIONS_PER_CYCLE === 0) {
            setMode('longBreak');
            setSecondsLeft(MODES.longBreak.minutes * 60);
          } else {
            setMode('shortBreak');
            setSecondsLeft(MODES.shortBreak.minutes * 60);
          }
        } else {
          setMode('work');
          setSecondsLeft(MODES.work.minutes * 60);
        }
      }, [mode, completedSessions, playNotification]);

      /** タイマーのカウントダウン */
      useEffect(() => {
        if (!isRunning) {
          return;
        }

        intervalRef.current = setInterval(() => {
          setSecondsLeft(prev => {
            if (prev <= 1) {
              clearInterval(intervalRef.current);
              // 次のtickで完了処理
              setTimeout(() => handleTimerComplete(), 0);
              return 0;
            }
            return prev - 1;
          });
        }, 1000);

        return () => clearInterval(intervalRef.current);
      }, [isRunning, handleTimerComplete]);

      /** モード切替 */
      const switchMode = useCallback((newMode) => {
        setIsRunning(false);
        clearInterval(intervalRef.current);
        setMode(newMode);
        setSecondsLeft(MODES[newMode].minutes * 60);
      }, []);

      /** 開始・一時停止トグル */
      const toggleTimer = useCallback(() => {
        setIsRunning(prev => !prev);
      }, []);

      /** リセット */
      const resetTimer = useCallback(() => {
        setIsRunning(false);
        clearInterval(intervalRef.current);
        setSecondsLeft(MODES[mode].minutes * 60);
      }, [mode]);

      /** スキップ（現在のタイマーを完了扱い） */
      const skipTimer = useCallback(() => {
        clearInterval(intervalRef.current);
        handleTimerComplete();
      }, [handleTimerComplete]);

      /** 合計作業時間のフォーマット */
      const formattedTotalTime = useMemo(() => {
        const h = Math.floor(totalWorkMinutes / 60);
        const m = totalWorkMinutes % 60;
        if (h > 0) {
          return `${h}h ${m}m`;
        }
        return `${m}m`;
      }, [totalWorkMinutes]);

      const modeConfig = MODES[mode];
      const modeClass = modeConfig.className;

      return (
        <div className="container">
          <h1>Pomodoro Timer</h1>
          <p className="subtitle">集中と休息のリズムで生産性を向上</p>

          {/* モード切替タブ */}
          <div className="mode-tabs">
            {Object.entries(MODES).map(([key, cfg]) => (
              <button
                key={key}
                className={`mode-tab ${mode === key ? `active-${cfg.className}` : ''}`}
                onClick={() => switchMode(key)}
              >
                {cfg.label} ({cfg.minutes}分)
              </button>
            ))}
          </div>

          {/* セッションドット */}
          <SessionDots completedSessions={completedSessions} currentMode={mode} />

          {/* タイマー */}
          <div className="timer-wrapper">
            <TimerCircle
              secondsLeft={secondsLeft}
              totalSeconds={totalSeconds}
              mode={mode}
              isRunning={isRunning}
            />
          </div>

          {/* コントロール */}
          <div className="controls">
            <button className="btn-control" onClick={resetTimer} title="リセット">
              <ResetIcon />
            </button>
            <button
              className={`btn-control btn-primary ${modeClass}-mode`}
              onClick={toggleTimer}
              title={isRunning ? '一時停止' : '開始'}
            >
              {isRunning ? <PauseIcon /> : <PlayIcon />}
            </button>
            <button className="btn-control" onClick={skipTimer} title="スキップ">
              <SkipIcon />
            </button>
          </div>

          {/* セッション情報 */}
          <div className="session-info">
            <div className="session-stat">
              <div className="stat-value">{completedSessions}</div>
              <div className="stat-label">完了セッション</div>
            </div>
            <div className="session-stat">
              <div className="stat-value">{formattedTotalTime}</div>
              <div className="stat-label">合計作業時間</div>
            </div>
            <div className="session-stat">
              <div className="stat-value">
                {completedSessions > 0
                  ? `${Math.floor(completedSessions / SESSIONS_PER_CYCLE)}`
                  : '0'}
              </div>
              <div className="stat-label">完了サイクル</div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PomodoroApp />);
  </script>
</body>
</html>
